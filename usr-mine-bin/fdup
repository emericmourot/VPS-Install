#!/bin/bash
#set -x

before="$(date +%s)"

# from http://www.commandlinefu.com/commands/view/3555/find-duplicate-files-based-on-size-first-then-md5-hash
TARGET=$1
TMPFDUP1=/tmp/fdup.$$.1.tmp
TMPFDUP2=/tmp/fdup.$$.2.tmp
TMPFDUP3=/tmp/fdup.$$.3.tmp
DOUBLONS=$TARGET/zzz-doublons.txt
FSIZES=$TARGET/zzz-dirsizes.txt
DOUBLONSIGNORED=$TARGET/zzz-doublons.ignored.txt

TIMESTAMP=`date`

find $TARGET -not -empty -type f -printf "%s\n" | sort -rn | uniq -d | xargs -I{} -n1 find -type f -size {}c -print0 | xargs -0 md5sum | sort | uniq -w32 --all-repeated=separate > $TMPFDUP1

cat $TMPFDUP1 | grep -v ".DS_Store" > $TMPFDUP2
N=`cat $TMPFDUP2 | wc -l`
#echo "$N lines in duplicates"
sort -rn $DOUBLONSIGNORED | grep -v "^#" > $TMPFDUP3 
P=`cat $TMPFDUP3 | wc -l`
#echo "$P keys" 
grep -v -f $TMPFDUP3 $TMPFDUP2 > $TMPFDUP1
Q=`cat $TMPFDUP1 | wc -l`
#echo "$Q after substraction" 
M=`expr $N - $Q`
#echo "$M left" 

echo "# DO NOT EDIT THIS FILE (GENERATED EVERY NIGHT)" > $DOUBLONS
echo "# DO NOT EDIT THIS FILE (GENERATED EVERY NIGHT)" > $FSIZES
echo "# " >> $DOUBLONS
echo "# " >> $FSIZES
echo "# Bash shell script by Emeric Mourot 1O/2012" >> $DOUBLONS
echo "# Bash shell script by Emeric Mourot 1O/2012" >> $FSIZES
echo "# " >> $DOUBLONS
echo "# " >> $DOUBLONS
echo "# " >> $FSIZES
echo "# " >> $FSIZES
echo "# Check for duplicate files in $TARGET" >> $DOUBLONS
echo "# " >> $DOUBLONS
echo "# $TIMESTAMP" >> $DOUBLONS
echo "# $TIMESTAMP" >> $FSIZES
echo "# " >> $FSIZES
echo "# " >> $DOUBLONS
echo "# $N files found (doublons)" >> $DOUBLONS
echo "# " >> $DOUBLONS
echo "# $P key(s) read from $DOUBLONSIGNORED" >> $DOUBLONS
echo "# " >> $DOUBLONS
echo "# $M line(s) removed" >> $DOUBLONS
echo "# " >> $DOUBLONS
after="$(date +%s)"
elapsed_seconds="$(expr $after - $before)"
echo "# Done in $elapsed_seconds second(s)" >> $DOUBLONS
echo "# " >> $DOUBLONS
cat $TMPFDUP1 >> $DOUBLONS 

chown www-data:www-data $DOUBLONS

du -k $TARGET | sort -nr | cut -f2 | xargs -d '\n' du -sh >> $FSIZES 
 
rm -f $TMPFDUP1 $TMPFDUP2 $TMPFDUP3 
